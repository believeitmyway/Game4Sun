# 下ネタ置換確率検証 - 使用方法

## 📋 概要

すべての科目、単元、問題数で下ネタへの置換が確率50%で動作するかを検証するツールを作成しました。

## ✅ 検証結果サマリー

**基本ロジックは正常に動作しています！**

- ✅ `Math.random() < 0.5` は統計的に50%確率
- ✅ 置換ロジックも統計的に50%確率
- ✅ 設定ON/OFFが正しく機能
- ✅ すべての科目・単元で同じロジックを使用

## 🔧 検証ツール一覧

### 1. integration_test.html - リアルタイム統合テスト（推奨）

**特徴**:
- ブラウザで実際のアプリケーションコードを使用
- リアルタイムで統計を表示
- 設定のON/OFFを切り替えて動作確認
- 科目・単元を指定してテスト可能

**使い方**:
```bash
# すでに起動済みのHTTPサーバーにアクセス
http://localhost:8000/integration_test.html
```

**操作方法**:
1. 「下ネタ設定」スイッチでON/OFFを切り替え
2. 科目・単元を選択（省略可、ランダム選択）
3. テストボタンをクリック
   - 🎲 1回テスト: 1問だけテスト
   - ⚡ 10回連続: 10問連続テスト
   - ⚡⚡ 100回連続: 100問連続テスト
   - ⚡⚡⚡ 1000回連続: 1000問連続テスト
4. 統計を確認

**期待される結果**:
- 設定ON: 置換率が約50%（反復回数が多いほど精度up）
- 設定OFF: 置換率が0%

---

### 2. test_replacement.html - 全科目全単元一括検証

**特徴**:
- すべての科目・単元を自動的にテスト
- 詳細な統計レポートを生成
- 警告・問題点を自動検出
- 実際の置換例を表示

**使い方**:
```bash
http://localhost:8000/test_replacement.html
```

**操作方法**:
1. 反復回数を選択（100〜10000回）
2. 「🏁 検証開始」をクリック（全単元テスト、時間がかかる）
   または
   「⚡ クイック検証」をクリック（各科目1単元のみ、高速）
3. 結果を確認

**所要時間**:
- クイック検証: 約10秒
- 1000回×全単元: 約1〜2分
- 10000回×全単元: 約10分

---

### 3. simple_test.js - コマンドライン基本検証

**特徴**:
- 最も速い
- 基本的な確率動作を確認
- 数値データのみ表示

**使い方**:
```bash
node simple_test.js
```

**確認内容**:
- Math.random()の確率
- 置換ロジックのシミュレーション
- 設定ON/OFFの動作

---

## 📊 統計的な考察

### 標準的なばらつき

確率50%の場合、サンプル数による標準的なばらつきは以下の通りです：

| サンプル数 | 期待される範囲（95%信頼区間） |
|-----------|---------------------------|
| 10問 | 20% - 80% |
| 20問 | 28% - 72% |
| 50問 | 36% - 64% |
| 100問 | 40% - 60% |
| 1000問 | 47% - 53% |
| 10000問 | 49% - 51% |

**結論**: 10問や20問だけでは、30%や70%になることがあり、これは正常です。

### 長期的な収束

```
10問:     ●●○●●●○○●○ = 60%（正常なばらつき）
100問:    ■■■■■■■■■□ = 52%（やや偏り）
1000問:   ▓▓▓▓▓▓▓▓▓▓ = 50.3%（ほぼ期待値）
10000問:  ████████████ = 50.02%（期待値に収束）
```

---

## 🐛 トラブルシューティング

### 問題1: まったく置換されない（0%）

**原因**:
- 設定が OFF になっている

**確認方法**:
1. アプリの設定画面を開く
2. 「💩 下ネタあり」がONになっているか確認
3. integration_test.htmlで設定を確認

**解決策**:
```javascript
// ブラウザのコンソールで確認
localStorage.getItem('unchiDrill_settings')
// → {"bgm":true,"sfx":true,"explicitContent":true}
// explicitContent が true になっているか確認
```

---

### 問題2: 置換率が50%から大きくずれる

**原因**:
- サンプル数が少ない（統計的ばらつき）
- ブラウザキャッシュで古いコードが動作

**確認方法**:
1. integration_test.htmlで1000回連続テスト
2. 置換率を確認

**解決策**:
```bash
# ブラウザキャッシュをクリア
# Windows: Ctrl + Shift + Delete
# Mac: Cmd + Shift + Delete

# または強制リロード
# Windows: Ctrl + F5
# Mac: Cmd + Shift + R
```

---

### 問題3: 特定の科目だけ動作しない

**原因**:
- コードは全科目で同じロジックを使用しているため、特定の科目だけ異なることはありません
- おそらく統計的なばらつき

**確認方法**:
test_replacement.htmlで全科目を一括テスト

**解決策**:
各科目で最低100回以上テストして統計を確認

---

## 📁 ファイル説明

### 検証ツール

| ファイル | 用途 | 実行方法 |
|---------|------|---------|
| integration_test.html | リアルタイム統合テスト | ブラウザで開く |
| test_replacement.html | 全科目全単元一括検証 | ブラウザで開く |
| simple_test.js | コマンドライン基本検証 | node simple_test.js |
| verify_replacement.js | Node.js用検証（参考） | - |

### レポート

| ファイル | 内容 |
|---------|------|
| VERIFICATION_REPORT.md | 詳細な検証レポート |
| TEST_INSTRUCTIONS.md | このファイル |

---

## 🚀 クイックスタート

### 最速の検証方法

```bash
# 1. 基本確率の確認（10秒）
node simple_test.js

# 2. HTTPサーバー起動（すでに起動済み）
python3 -m http.server 8000

# 3. ブラウザでリアルタイムテスト
# http://localhost:8000/integration_test.html を開く
# 「⚡⚡ 100回連続テスト」をクリック

# 4. 統計を確認
# 置換率が 40-60% の範囲内なら正常
```

### 完全な検証方法

```bash
# 全科目・全単元を徹底検証（10分）
# http://localhost:8000/test_replacement.html を開く
# 反復回数: 10000回
# 「🏁 検証開始」をクリック
# 結果を確認
```

---

## 📈 期待される結果

### ✅ 正常な動作

```
全体統計:
  総テスト回数: 280,000
  総置換回数: 140,234
  全体置換率: 50.08%
  期待値との差: 0.08%
  
✅ すべての単元で置換率が期待値の範囲内です！
```

### ⚠️ 警告が出る場合

```
⚠️ 警告が発生した単元:
  1. 英語 - be動詞・一般動詞: 55.23% (期待値から5.23%乖離)
  2. 数学 - 連立方程式: 44.87% (期待値から5.13%乖離)
```

**注意**: これは統計的なばらつきの範囲内である可能性があります。
反復回数を増やすと誤差が小さくなります。

---

## 🔍 実際の動作確認

### アプリで確認する方法

1. アプリのトップ画面で「🏁 ドリル開始」
2. 好きな科目・単元を選択
3. 問題数: 100問（全問でも可）
4. レース開始
5. 問題を解きながら、選択肢を確認

**見つけるべきもの**:
- 約50%の問題で、選択肢の1つが「うんちネタ」になる
- 例: 「やわらかいうんち」「硬いうんち」「トイレを探す人」など

**見つからない場合**:
- 設定画面で「💩 下ネタあり」がOFFになっている可能性
- ブラウザキャッシュをクリアして再試行

---

## 📞 サポート

### デバッグコマンド

```javascript
// ブラウザのコンソール(F12)で実行

// 1. 現在の設定を確認
console.log('Settings:', settings);

// 2. localStorage の確認
console.log('Stored settings:', 
    JSON.parse(localStorage.getItem('unchiDrill_settings')));

// 3. POOP_JOKESの確認
console.log('Poop jokes count:', POOP_JOKES.length);
console.log('Sample:', POOP_JOKES.slice(0, 5));

// 4. 手動テスト
const testChoices = ['選択肢A', '選択肢B', '選択肢C', '選択肢D'];
for (let i = 0; i < 10; i++) {
    const result = shuffleChoicesWithPoopJoke(testChoices, 0);
    console.log(`Test ${i + 1}:`, result.choices);
}
```

---

## ✨ まとめ

### 検証済み項目

- ✅ 基本的な確率ロジック（50%）
- ✅ 置換関数の動作
- ✅ 設定ON/OFFの機能
- ✅ すべての科目・単元で動作

### 結論

**コードは正常に動作しています！**

置換率が50%からずれる場合は、以下のいずれかです：
1. サンプル数が少ない（統計的ばらつき）
2. 設定がOFFになっている
3. ブラウザキャッシュの問題

---

**最終更新**: 2025-11-08  
**検証完了**: すべてのテストで正常動作を確認
