<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‹ãƒã‚¿ç½®æ›ç¢ºç‡æ¤œè¨¼</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #8B4513;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 30px;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #ddd;
        }
        .test-result.pass {
            border-left-color: #4CAF50;
            background-color: #e8f5e9;
        }
        .test-result.warning {
            border-left-color: #FF9800;
            background-color: #fff3e0;
        }
        .test-result.fail {
            border-left-color: #f44336;
            background-color: #ffebee;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #8B4513 0%, #654321 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        button {
            background-color: #8B4513;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #654321;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .progress {
            width: 100%;
            height: 30px;
            background-color: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #8B4513, #654321);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .details {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #fafafa;
            font-family: monospace;
            font-size: 0.9em;
        }
        .example-box {
            background: #f0f0f0;
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ’© ä¸‹ãƒã‚¿ç½®æ›ã®ç¢ºç‡æ¤œè¨¼ãƒ„ãƒ¼ãƒ«</h1>
    
    <div class="test-section">
        <h2>ãƒ†ã‚¹ãƒˆè¨­å®š</h2>
        <p>å„å˜å…ƒã§è¤‡æ•°å›ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã€50%ç¢ºç‡ã§ç½®æ›ã•ã‚Œã‚‹ã‹ã‚’æ¤œè¨¼ã—ã¾ã™</p>
        <label>
            åå¾©å›æ•°ï¼ˆå„å˜å…ƒã”ã¨ï¼‰:
            <select id="iterations">
                <option value="100">100å›ï¼ˆé«˜é€Ÿï¼‰</option>
                <option value="1000" selected>1000å›ï¼ˆæ¨™æº–ï¼‰</option>
                <option value="5000">5000å›ï¼ˆç²¾å¯†ï¼‰</option>
                <option value="10000">10000å›ï¼ˆæœ€é«˜ç²¾åº¦ï¼‰</option>
            </select>
        </label>
        <br><br>
        <button onclick="runFullTest()" id="runBtn">ğŸ æ¤œè¨¼é–‹å§‹</button>
        <button onclick="runQuickTest()" id="quickBtn">âš¡ ã‚¯ã‚¤ãƒƒã‚¯æ¤œè¨¼ï¼ˆã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼‰</button>
    </div>

    <div class="progress" id="progressContainer" style="display: none;">
        <div class="progress-bar" id="progressBar">0%</div>
    </div>

    <div class="test-section" id="overallStats" style="display: none;">
        <h2>ğŸ“Š å…¨ä½“çµ±è¨ˆ</h2>
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">ç·ãƒ†ã‚¹ãƒˆå›æ•°</div>
                <div class="stat-value" id="totalTests">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ç½®æ›ç™ºç”Ÿå›æ•°</div>
                <div class="stat-value" id="totalReplacements">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å…¨ä½“ç½®æ›ç‡</div>
                <div class="stat-value" id="overallRate">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æœŸå¾…å€¤ã¨ã®å·®</div>
                <div class="stat-value" id="deviation">0%</div>
            </div>
        </div>
    </div>

    <div class="test-section" id="resultsSection" style="display: none;">
        <h2>ğŸ“ ç§‘ç›®ãƒ»å˜å…ƒåˆ¥çµæœ</h2>
        <div id="results"></div>
    </div>

    <div class="test-section" id="issuesSection" style="display: none;">
        <h2>âš ï¸ è­¦å‘Šãƒ»å•é¡Œç‚¹</h2>
        <div id="issues"></div>
    </div>

    <div class="test-section" id="examplesSection" style="display: none;">
        <h2>ğŸ” å®Ÿéš›ã®ç½®æ›ä¾‹</h2>
        <div id="examples"></div>
    </div>

    <script src="data.js"></script>
    <script>
        // è¨­å®šã‚’æœ‰åŠ¹åŒ–
        let settings = { explicitContent: true };

        // ã†ã‚“ã¡ãƒã‚¿ãƒªã‚¹ãƒˆï¼ˆapp.jsã‹ã‚‰ï¼‰
        const POOP_JOKES = [
            'ã‚„ã‚ã‚‰ã‹ã„ã†ã‚“ã¡', 'ç¡¬ã„ã†ã‚“ã¡', 'æ¼ã‚Œãã†ãªäºº', 'èŒ¶è‰²ã„ã‚½ãƒ•ãƒˆã‚¯ãƒªãƒ¼ãƒ ',
            'ã‚³ãƒ­ã‚³ãƒ­ã†ã‚“ã¡', 'ãƒãƒŠãƒŠå‹ã†ã‚“ã¡', 'ä¸‹ç—¢æ°—å‘³ã®äºº', 'ãƒˆã‚¤ãƒ¬ã‚’æ¢ã™äºº',
            'ã‚¦ã‚©ã‚·ãƒ¥ãƒ¬ãƒƒãƒˆå¾…ã¡', 'ã†ã‚“ã¡ã‚’æˆ‘æ…¢ä¸­', 'ä»Šã™ããƒˆã‚¤ãƒ¬ãŒå¿…è¦', 'ãŠãªã‚‰æˆ‘æ…¢',
            'ãŠãªã‚‰ãŒå‡ºãã†', 'ã¶ã‚Šã¶ã‚Šã†ã‚“ã¡', 'ã‚‚ã‚Šã‚‚ã‚Šã†ã‚“ã¡', 'ã™ã‚‹ã™ã‚‹ã†ã‚“ã¡',
            'ãƒ„ãƒ«ãƒ„ãƒ«ã†ã‚“ã¡', 'ã¹ã¡ã‚ƒã¹ã¡ã‚ƒã†ã‚“ã¡', 'ã“ã‚“ã‚‚ã‚Šã†ã‚“ã¡', 'ã¨ãã‚ã‚’å·»ã„ãŸã†ã‚“ã¡',
            'ã†ã‚“ã¡5ç§’å‰', 'ã†ã‚“ã¡ã‚¿ã‚¤ãƒ ', 'ãƒˆã‚¤ãƒ¬ã®ç¥æ§˜', 'ä¾¿ç§˜3æ—¥ç›®', 'ä¾¿ç§˜1é€±é–“',
            'ãŠè…¹ã‚´ãƒ­ã‚´ãƒ­', 'ãŠãªã‹ãƒ”ãƒ¼ãƒ”ãƒ¼', 'ãã°ã£ã¦ã‚‹äºº', 'ã„ãã‚“ã§ã‚‹äºº', 'ãµã‚“ã°ã‚Šä¸­',
            'ãƒˆã‚¤ãƒ¬ãƒƒãƒˆãƒšãƒ¼ãƒ‘ãƒ¼10å·»', 'ã‚¦ã‚©ã‚·ãƒ¥ãƒ¬ãƒƒãƒˆMAX', 'éŸ³å§«ãƒ•ãƒ«ç¨¼åƒ', 'å€‹å®¤ã«é§†ã‘è¾¼ã‚€',
            'å¤§ã®æ–¹ã§ã™', 'ã—ã‚ƒãŒã¿ã“ã‚€äºº', 'ãã•ã„ã†ã‚“ã¡', 'ãã•ã„ãŠãªã‚‰', 'ã«ãŠã†ã‚„ã¤',
            'ãƒ—ãƒ³ãƒ—ãƒ³ä¸¸', 'ã‚¹ãƒ«ãƒƒã¨å‡ºãŸ', 'ã‚¹ãƒƒã‚­ãƒªã†ã‚“ã¡', 'ãŠè…¹ã®ä¸­ãŒå¤§å¤‰', 'è…¸å†…ç’°å¢ƒæœ€æ‚ª',
            'ä¹³é…¸èŒä¸è¶³', 'é£Ÿç‰©ç¹Šç¶­ãŒå¿…è¦', 'ãƒˆã‚¤ãƒ¬ã«30åˆ†', 'ãƒˆã‚¤ãƒ¬ã‹ã‚‰å‡ºã‚‰ã‚Œãªã„',
            'ãƒãƒƒã‚¯ã•ã‚Œã¦ã‚ã›ã‚‹', 'ã‚‚ã‚ˆãŠã—ã¦ããŸ', 'ä¾¿æ„ãŒè¥²ã†', 'è…¹ç—›ã§å†·ã‚„æ±—'
        ];

        function shuffleChoicesWithPoopJoke(choices, correctAnswerIndex) {
            const choicesWithIndex = choices.map((choice, index) => ({
                text: choice,
                isCorrect: index === correctAnswerIndex
            }));
            
            const shouldAddPoopJoke = settings.explicitContent && Math.random() < 0.5;
            
            if (shouldAddPoopJoke) {
                const wrongIndices = [];
                choicesWithIndex.forEach((item, index) => {
                    if (!item.isCorrect) {
                        wrongIndices.push(index);
                    }
                });
                
                if (wrongIndices.length > 0) {
                    const targetIndex = wrongIndices[Math.floor(Math.random() * wrongIndices.length)];
                    const randomPoopJoke = POOP_JOKES[Math.floor(Math.random() * POOP_JOKES.length)];
                    choicesWithIndex[targetIndex].text = randomPoopJoke;
                }
            }
            
            for (let i = choicesWithIndex.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [choicesWithIndex[i], choicesWithIndex[j]] = [choicesWithIndex[j], choicesWithIndex[i]];
            }
            
            let newCorrectIndex = -1;
            const shuffledChoices = choicesWithIndex.map((item, index) => {
                if (item.isCorrect) {
                    newCorrectIndex = index;
                }
                return item.text;
            });
            
            return {
                choices: shuffledChoices,
                correctIndex: newCorrectIndex,
                hadPoopJoke: shouldAddPoopJoke
            };
        }

        async function runFullTest() {
            const iterations = parseInt(document.getElementById('iterations').value);
            document.getElementById('runBtn').disabled = true;
            document.getElementById('quickBtn').disabled = true;
            
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('overallStats').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('issuesSection').style.display = 'none';
            document.getElementById('examplesSection').style.display = 'none';
            
            const results = [];
            let totalTests = 0;
            let totalReplacements = 0;
            const issues = [];
            const examples = [];
            
            let unitCount = 0;
            let processedUnits = 0;
            
            // ç·å˜å…ƒæ•°ã‚’è¨ˆç®—
            for (const subjectId in QUESTION_DATABASE) {
                const subject = QUESTION_DATABASE[subjectId];
                for (const unitId in subject.units) {
                    unitCount++;
                }
            }
            
            // å„ç§‘ç›®ãƒ»å˜å…ƒã‚’ãƒ†ã‚¹ãƒˆ
            for (const subjectId in QUESTION_DATABASE) {
                const subject = QUESTION_DATABASE[subjectId];
                const subjectResult = {
                    name: subject.name,
                    units: []
                };
                
                for (const unitId in subject.units) {
                    const unit = subject.units[unitId];
                    const multipleChoiceQuestions = unit.questions.filter(q => q.type === 'multiple');
                    
                    if (multipleChoiceQuestions.length === 0) {
                        processedUnits++;
                        continue;
                    }
                    
                    let replacementCount = 0;
                    let exampleFound = false;
                    
                    for (let i = 0; i < iterations; i++) {
                        const randomQuestion = multipleChoiceQuestions[
                            Math.floor(Math.random() * multipleChoiceQuestions.length)
                        ];
                        
                        const result = shuffleChoicesWithPoopJoke(
                            randomQuestion.choices,
                            randomQuestion.answer
                        );
                        
                        if (result.hadPoopJoke) {
                            replacementCount++;
                            
                            // ä¾‹ã‚’ä¿å­˜ï¼ˆæœ€åˆã®5å€‹ã¾ã§ï¼‰
                            if (!exampleFound && examples.length < 5) {
                                const hasPoopJoke = result.choices.some(choice => 
                                    POOP_JOKES.includes(choice)
                                );
                                if (hasPoopJoke) {
                                    examples.push({
                                        subject: subject.name,
                                        unit: unit.name,
                                        question: randomQuestion.question,
                                        original: randomQuestion.choices.join(', '),
                                        modified: result.choices.join(', ')
                                    });
                                    exampleFound = true;
                                }
                            }
                        }
                    }
                    
                    const rate = (replacementCount / iterations) * 100;
                    totalTests += iterations;
                    totalReplacements += replacementCount;
                    
                    const unitResult = {
                        name: unit.name,
                        questionCount: multipleChoiceQuestions.length,
                        replacementCount: replacementCount,
                        rate: rate,
                        deviation: Math.abs(rate - 50)
                    };
                    
                    subjectResult.units.push(unitResult);
                    
                    // è­¦å‘Šãƒã‚§ãƒƒã‚¯
                    if (unitResult.deviation > 5) {
                        issues.push({
                            subject: subject.name,
                            unit: unit.name,
                            rate: rate,
                            deviation: unitResult.deviation
                        });
                    }
                    
                    processedUnits++;
                    const progress = (processedUnits / unitCount) * 100;
                    document.getElementById('progressBar').style.width = progress + '%';
                    document.getElementById('progressBar').textContent = Math.round(progress) + '%';
                    
                    // UIã®æ›´æ–°ã‚’å¾…ã¤
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
                
                results.push(subjectResult);
            }
            
            // çµæœã‚’è¡¨ç¤º
            displayResults(results, totalTests, totalReplacements, issues, examples);
            
            document.getElementById('runBtn').disabled = false;
            document.getElementById('quickBtn').disabled = false;
        }

        async function runQuickTest() {
            // å„ç§‘ç›®ã‹ã‚‰1å˜å…ƒãšã¤ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
            const iterations = 1000;
            document.getElementById('runBtn').disabled = true;
            document.getElementById('quickBtn').disabled = true;
            
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('overallStats').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('issuesSection').style.display = 'none';
            document.getElementById('examplesSection').style.display = 'none';
            
            const results = [];
            let totalTests = 0;
            let totalReplacements = 0;
            const issues = [];
            const examples = [];
            
            let subjectCount = Object.keys(QUESTION_DATABASE).length;
            let processedSubjects = 0;
            
            for (const subjectId in QUESTION_DATABASE) {
                const subject = QUESTION_DATABASE[subjectId];
                const subjectResult = {
                    name: subject.name,
                    units: []
                };
                
                // æœ€åˆã®å˜å…ƒã®ã¿ãƒ†ã‚¹ãƒˆ
                const firstUnitId = Object.keys(subject.units)[0];
                const unit = subject.units[firstUnitId];
                const multipleChoiceQuestions = unit.questions.filter(q => q.type === 'multiple');
                
                if (multipleChoiceQuestions.length > 0) {
                    let replacementCount = 0;
                    
                    for (let i = 0; i < iterations; i++) {
                        const randomQuestion = multipleChoiceQuestions[
                            Math.floor(Math.random() * multipleChoiceQuestions.length)
                        ];
                        
                        const result = shuffleChoicesWithPoopJoke(
                            randomQuestion.choices,
                            randomQuestion.answer
                        );
                        
                        if (result.hadPoopJoke) {
                            replacementCount++;
                            
                            if (examples.length < 5) {
                                const hasPoopJoke = result.choices.some(choice => 
                                    POOP_JOKES.includes(choice)
                                );
                                if (hasPoopJoke) {
                                    examples.push({
                                        subject: subject.name,
                                        unit: unit.name,
                                        question: randomQuestion.question,
                                        original: randomQuestion.choices.join(', '),
                                        modified: result.choices.join(', ')
                                    });
                                }
                            }
                        }
                    }
                    
                    const rate = (replacementCount / iterations) * 100;
                    totalTests += iterations;
                    totalReplacements += replacementCount;
                    
                    const unitResult = {
                        name: unit.name,
                        questionCount: multipleChoiceQuestions.length,
                        replacementCount: replacementCount,
                        rate: rate,
                        deviation: Math.abs(rate - 50)
                    };
                    
                    subjectResult.units.push(unitResult);
                    
                    if (unitResult.deviation > 5) {
                        issues.push({
                            subject: subject.name,
                            unit: unit.name,
                            rate: rate,
                            deviation: unitResult.deviation
                        });
                    }
                }
                
                results.push(subjectResult);
                
                processedSubjects++;
                const progress = (processedSubjects / subjectCount) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressBar').textContent = Math.round(progress) + '%';
                
                await new Promise(resolve => setTimeout(resolve, 0));
            }
            
            displayResults(results, totalTests, totalReplacements, issues, examples);
            
            document.getElementById('runBtn').disabled = false;
            document.getElementById('quickBtn').disabled = false;
        }

        function displayResults(results, totalTests, totalReplacements, issues, examples) {
            const overallRate = (totalReplacements / totalTests) * 100;
            const deviation = Math.abs(overallRate - 50);
            
            // å…¨ä½“çµ±è¨ˆ
            document.getElementById('totalTests').textContent = totalTests.toLocaleString();
            document.getElementById('totalReplacements').textContent = totalReplacements.toLocaleString();
            document.getElementById('overallRate').textContent = overallRate.toFixed(2) + '%';
            document.getElementById('deviation').textContent = deviation.toFixed(2) + '%';
            document.getElementById('overallStats').style.display = 'block';
            
            // ç§‘ç›®ãƒ»å˜å…ƒåˆ¥çµæœ
            let resultsHtml = '';
            results.forEach(subject => {
                resultsHtml += `<h3>${subject.name}</h3>`;
                subject.units.forEach(unit => {
                    const statusClass = unit.deviation <= 5 ? 'pass' : (unit.deviation <= 10 ? 'warning' : 'fail');
                    const statusIcon = unit.deviation <= 5 ? 'âœ…' : (unit.deviation <= 10 ? 'âš ï¸' : 'âŒ');
                    resultsHtml += `
                        <div class="test-result ${statusClass}">
                            ${statusIcon} <strong>${unit.name}</strong> (${unit.questionCount}å•)<br>
                            ç½®æ›ç‡: ${unit.rate.toFixed(2)}% (${unit.replacementCount}/${totalTests / results.reduce((sum, s) => sum + s.units.length, 0)}å›)
                            æœŸå¾…å€¤ã¨ã®å·®: ${unit.deviation.toFixed(2)}%
                        </div>
                    `;
                });
            });
            document.getElementById('results').innerHTML = resultsHtml;
            document.getElementById('resultsSection').style.display = 'block';
            
            // è­¦å‘Šãƒ»å•é¡Œç‚¹
            if (issues.length > 0) {
                let issuesHtml = '<p>ä»¥ä¸‹ã®å˜å…ƒã§æœŸå¾…å€¤ã‹ã‚‰5%ä»¥ä¸Šä¹–é›¢ã—ã¦ã„ã¾ã™ï¼š</p>';
                issues.forEach((issue, index) => {
                    issuesHtml += `
                        <div class="test-result warning">
                            ${index + 1}. ${issue.subject} - ${issue.unit}<br>
                            ç½®æ›ç‡: ${issue.rate.toFixed(2)}% (æœŸå¾…å€¤ã‹ã‚‰${issue.deviation.toFixed(2)}%ä¹–é›¢)
                        </div>
                    `;
                });
                issuesHtml += '<p><em>æ³¨: ã“ã‚Œã¯çµ±è¨ˆçš„ãªã°ã‚‰ã¤ãã®ç¯„å›²å†…ã§ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç‰¹ã«åå¾©å›æ•°ãŒå°‘ãªã„å ´åˆã¯èª¤å·®ãŒå¤§ãããªã‚Šã¾ã™ã€‚</em></p>';
                document.getElementById('issues').innerHTML = issuesHtml;
                document.getElementById('issuesSection').style.display = 'block';
            } else {
                document.getElementById('issues').innerHTML = '<div class="test-result pass">âœ… ã™ã¹ã¦ã®å˜å…ƒã§ç½®æ›ç‡ãŒæœŸå¾…å€¤ã®ç¯„å›²å†…ã§ã™ï¼</div>';
                document.getElementById('issuesSection').style.display = 'block';
            }
            
            // å®Ÿéš›ã®ç½®æ›ä¾‹
            if (examples.length > 0) {
                let examplesHtml = '<p>å®Ÿéš›ã«ç½®æ›ãŒè¡Œã‚ã‚ŒãŸä¾‹ï¼š</p>';
                examples.forEach((example, index) => {
                    examplesHtml += `
                        <div class="example-box">
                            <strong>${index + 1}. ${example.subject} - ${example.unit}</strong><br>
                            å•é¡Œ: ${example.question}<br>
                            <strong>å…ƒã®é¸æŠè‚¢:</strong> ${example.original}<br>
                            <strong>ç½®æ›å¾Œã®é¸æŠè‚¢:</strong> <span style="color: #8B4513; font-weight: bold;">${example.modified}</span>
                        </div>
                    `;
                });
                document.getElementById('examples').innerHTML = examplesHtml;
                document.getElementById('examplesSection').style.display = 'block';
            }
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’éè¡¨ç¤º
            document.getElementById('progressContainer').style.display = 'none';
        }
    </script>
</body>
</html>
